<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞ ‚Äî Teplostil</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="assets/icon.png">
<style>*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#ffffff;color:#0f172a}
.header{position:fixed;top:0;left:0;right:0;height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:#ffffff;border-bottom:1px solid #e5e7eb;z-index:20}
.brand{font-weight:700;letter-spacing:.3px;color:#0f172a}
.cart{position:relative;cursor:pointer}
.cart .badge{position:absolute;top:-6px;right:-8px;background:#2563eb;color:#fff;border-radius:12px;padding:2px 6px;font-size:12px;min-width:20px;text-align:center}
.container{max-width:900px;margin:120px auto 64px;padding:0 16px}
.search-wrap{display:flex;align-items:center;gap:8px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:999px;padding:8px 16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.search-wrap input{flex:1;background:transparent;border:0;outline:0;color:#0f172a;font-size:20px;padding:8px}
.search-results{position:relative;margin-top:14px}
.dropdown{position:absolute;left:0;right:0;background:#ffffff;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;max-height:520px;overflow-y:auto;box-shadow:0 8px 24px rgba(15,23,42,.08)}
.item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid #f1f5f9}
.item:last-child{border-bottom:0}
.thumb{width:48px;height:48px;border-radius:8px;background:#f1f5f9;object-fit:cover;flex:0 0 48px;border:1px solid #e5e7eb}
.meta{display:flex;flex-direction:column;gap:2px;min-width:0}
.title{font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#0f172a}
.sku{font-size:13px;color:#64748b}
.item .actions{margin-left:auto;display:flex;gap:8px}
.btn{background:#f8fafc;border:1px solid #e5e7eb;color:#0f172a;border-radius:10px;padding:6px 10px;font-size:14px;cursor:pointer}
.btn:hover{background:#eef2f7}
.footer{opacity:.8;font-size:12px;text-align:center;margin-top:32px;color:#475569}
.link{color:#2563eb;text-decoration:none}
.help{margin-top:12px;font-size:13px;color:#475569}
.admin{margin-top:18px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.admin input[type=file]{display:none}
.pill{border:1px dashed #cbd5e1;border-radius:999px;padding:6px 12px;font-size:13px;cursor:pointer;color:#0f172a;background:#ffffff}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#0f172a;color:#fff;border:1px solid #0f172a;padding:10px 14px;border-radius:10px;display:none;z-index:50}
.hidden{display:none}
mark{background:#fff3bf;padding:0 .1em;border-radius:.2em}
</style>
</head>
<body>
<header class="header">
  <div class="brand">Teplostil ¬∑ –ó–∞–∫–∞–∑</div>
  <div class="cart" onclick="openCart()">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="#0f172a"><path d="M7 4h-2l-1 2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.11.89 2 2 2h10v-2h-9.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h5.72c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1h-14.31l-.94-2zm-1 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
    <div id="cart-badge" class="badge">0</div>
  </div>
</header>

<main class="container">
  <div class="search-wrap">
    <input id="q" type="search" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–ª–∏ –∞—Ä—Ç–∏–∫—É–ª‚Ä¶" autocomplete="off" autofocus oninput="search()"/>
  </div>
  <div class="help">–ü–æ–∏—Å–∫ –ø–æ–Ω–∏–º–∞–µ—Ç ¬´—Ç—Ä—É–±–∞¬ª, ¬´–ø–µ—Ä—Ç/PERT¬ª, ¬´—ç–≤–æ/EVOH¬ª, ¬´–º/–ø¬ª –∏ –¥—Ä. –ü—Ä–∏–º–µ—Ä: <b>—Ç—Ä—É–±–∞ –ø–µ—Ä—Ç —ç–≤–æ–Ω 16</b></div>
  <div class="search-results">
    <div id="dropdown" class="dropdown hidden"></div>
  </div>

  <div class="admin">
    <label for="csv" class="pill">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å CSV —Å —Ñ–æ—Ç–æ (–ê—Ä—Ç–∏–∫—É–ª;image_small;image_large)</label>
    <input id="csv" type="file" accept=".csv" />
    <label for="pricecsv" class="pill">üí∞ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ü–µ–Ω—ã/–æ—Å—Ç–∞—Ç–∫–∏ (–ê—Ä—Ç–∏–∫—É–ª;–¶–µ–Ω–∞;–û—Å—Ç–∞—Ç–æ–∫)</label>
    <input id="pricecsv" type="file" accept=".csv" />
    <button class="pill" onclick="exportCartXLSX()">üì• Excel</button>
    <button class="pill" onclick="exportCartMXL()">üì• MXL</button>
    <a class="pill link" href="cart.html" target="_blank">üß∫ –û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É</a>
  </div>

  <div class="footer">–†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω ¬∑ –î–∞–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ ¬∑ CSV –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ Excel –±–µ–∑ ¬´–∫—Ä–∞–∫–æ–∑—è–±—Ä¬ª</div>
</main>

<div id="toast" class="toast"></div>

<script>
// ===== Shared state & helpers =====
const DB_URL = 'data/products.json'; // (–ê—Ä—Ç–∏–∫—É–ª, –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, image_small, image_large, –¶–µ–Ω–∞, –û—Å—Ç–∞—Ç–æ–∫)
let DB = [];
const CART_KEY = 'cart_v1';

function toast(msg){
  const t=document.getElementById('toast');
  if(!t) return; t.textContent=msg; t.style.display='block';
  setTimeout(()=>t.style.display='none',1800);
}

function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY)||'[]'); } catch(_){ return []; } }
function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); updateBadge(); }
function updateBadge(){
  const c = loadCart(); const cnt = c.reduce((s,i)=>s+(i.qty||0),0);
  const el = document.getElementById('cart-badge'); if(el) el.textContent = String(cnt);
}

function addToCart(item){
  const c = loadCart();
  const idx = c.findIndex(x=>x.art===item.art);
  if(idx>=0) c[idx].qty += 1;
  else c.push({art:item.art, name:item.name, img:item.img||'', qty:1, price:item.price||0});
  saveCart(c); toast('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É');
}
function removeFromCart(art){ const c = loadCart().filter(x=>x.art!==art); saveCart(c); }
function setQty(art, qty){
  qty = Math.max(0, parseInt(qty||0,10)); const c = loadCart();
  for(const it of c){ if(it.art===art) it.qty = qty; }
  saveCart(c.filter(x=>x.qty>0));
}
function imgOrPlaceholder(url){ return (url && url.length>3) ? url : 'assets/ph.png'; }
function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]) )}

// ===== CSV (images + price) =====
function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(Boolean); if(!lines.length) return [];
  const headers = lines[0].split(';').map(h=>h.trim());
  return lines.slice(1).map(line=>{
    const cols = line.split(';'); const obj = {}; headers.forEach((h,i)=>obj[h]=(cols[i]||'').trim());
    return obj;
  });
}

// ===== Export: Excel-friendly CSV (fix gibberish) =====
function exportCartXLSX(){
  const c = loadCart();
  const rows = [['–ê—Ä—Ç–∏–∫—É–ª','–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ','–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ','–¶–µ–Ω–∞','–°—É–º–º–∞'],
    ...c.map(i=>[i.art, i.name, i.qty, i.price||'', (i.qty||0)*(i.price||0)])
  ];
  const sep = ';';
  const lines = rows.map(r=>r.map(v=>{
    const s = String(v).replace(/"/g,'""');
    return `"${s}"`;
  }).join(sep));
  const csvContent = '\ufeff' + 'sep=;\n' + lines.join('\n');
  const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'order.csv';
  a.click();
}

// ===== Export: XML (.mxl placeholder) =====
function exportCartMXL(){
  const c = loadCart();
  const esc = s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const xml = ['<?xml version="1.0" encoding="UTF-8"?>','<order>']
    .concat(c.map(i=>`<item><art>${esc(i.art)}</art><name>${esc(i.name)}</name><qty>${i.qty}</qty><price>${i.price||''}</price></item>`))
    .concat(['</order>']).join('\n');
  const blob = new Blob([xml], {type:'application/xml;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'order.mxl';
  a.click();
}

// ===== Load DB (with local enrich) =====
async function loadDB(){
  if(DB.length) return DB;
  let arr = [];
  try{
    const res = await fetch(DB_URL, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    arr = await res.json();
  }catch(e){
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ products.json', e);
    toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ data/products.json');
    return [];
  }
  DB = arr.map(p=>({
    art: String(p['–ê—Ä—Ç–∏–∫—É–ª']||'').trim(),
    name: String(p['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ']||'').trim(),
    img: (p['image_small']||p['image_large']||'').trim(),
    imgLarge: (p['image_large']||p['image_small']||'').trim(),
    price: Number((p['–¶–µ–Ω–∞']||'').toString().replace(',','.'))||0,
    stock: Number((p['–û—Å—Ç–∞—Ç–æ–∫']||p['–ó–∞–ø–∞—Å']||'').toString().replace(',','.'))||0,
  }));

  const imagesCSV = localStorage.getItem('images_map_csv');
  if(imagesCSV){
    const map = parseCSV(imagesCSV);
    for(const row of map){
      const art = (row['–ê—Ä—Ç–∏–∫—É–ª']||'').trim();
      const it = DB.find(x=>x.art===art);
      if(it){ if(row['image_small']) it.img = row['image_small']; if(row['image_large']) it.imgLarge = row['image_large']; }
    }
  }
  const priceCSV = localStorage.getItem('price_map_csv');
  if(priceCSV){
    const map = parseCSV(priceCSV);
    for(const row of map){
      const art = (row['–ê—Ä—Ç–∏–∫—É–ª']||'').trim();
      const it = DB.find(x=>x.art===art);
      if(it){
        if(row['–¶–µ–Ω–∞']) it.price = Number(row['–¶–µ–Ω–∞'].replace(',','.'))||it.price;
        if(row['–û—Å—Ç–∞—Ç–æ–∫']) it.stock = Number(row['–û—Å—Ç–∞—Ç–æ–∫'].replace(',','.'))||it.stock;
      }
    }
  }
  return DB;
}

// ===== Search helpers (robust) =====
const syn = {
  "—Ç—Ä—É–±–∞":["—Ç—Ä—É–±–∞","—Ç—Ä—É–±–∫–∞","pipe"],
  "–ø–µ—Ä—Ç":["pert","pe-rt","pe rt","pe_rt","pe rt ii","pert-ii"],
  "—ç–≤–æ":["evoh","evo","–µ–≤–æ—Ö","—ç–≤–æx","evon","—ç–≤–æh"],
  "—ç–≤–æ–Ω":["evoh","evo"],
  "–µ–≤–æ—Ö":["evoh"],
  "–ø–µ–∫—Å":["pex","p-ex","p ex","p_ex"],
  "–º–ø":["–º–µ—Ç–∞–ª–ª–æ–ø–ª–∞—Å—Ç","–º–µ—Ç–∞–ª–ª–æ–ø–ª–∞—Å—Ç–∏–∫","–º/–ø","mp","metal-plast","metalplast","–º–µ—Ç–∞–ª–ª–æ–ø–ª"],
  "–Ω–µ—Ä–∂":["–Ω–µ—Ä–∂–∞–≤","–Ω–µ—Ä–∂–∞–≤–µ–π–∫–∞","stainless","inox"],
  "–≤–Ω–≤–Ω":["–≤–Ω-–≤–Ω","–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è","–≤–Ω—É—Ç—Ä-–≤–Ω—É—Ç—Ä"],
  "–Ω–∞—Ä–≤–Ω":["–Ω–∞—Ä-–≤–Ω","–Ω–∞—Ä—É–∂–Ω–∞—è-–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è"],
  "–≤–Ω–Ω–∞—Ä":["–≤–Ω-–Ω–∞—Ä","–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è-–Ω–∞—Ä—É–∂–Ω–∞—è"],
  "–∫–≥":["kg","–∫–∏–ª–æ–≥—Ä–∞–º–º"],
  "–º–º":["mm","–º–∏–ª–ª–∏–º–µ—Ç—Ä","–º–∏–ª–ª–∏–º–µ—Ç—Ä–∞","–º–∏–ª–ª–∏–º–µ—Ç—Ä–æ–≤"],
  "dn":["–¥—É","–¥–∏–∞–º–µ—Ç—Ä"]
};

function normalize(s){
  return String(s||'')
    .toLowerCase()
    .replace(/—ë/g,'–µ')
    .replace(/[^a-z0-9–∞-—è\-\/\.\s]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}
function tokenize(s){ return normalize(s).split(' ').filter(Boolean); }

function stemRU(t){
  const rules = ["–∞–º–∏","—è–º–∏","–µ–≤","–æ–≤","–∞—è","—ã–µ","–æ–π","–∏–π","—ã–π","–∞—è","–æ–µ","–µ–µ","—ã—Ö","–∏—Ö","–∞","—è","—ã","–∏"];
  for(const suf of rules){ if(t.endsWith(suf)) return t.slice(0, -suf.length); }
  return t;
}

function expandToken(t){
  const out = new Set([t, stemRU(t)]);
  if(/^\d+([.,]\d+)?$/.test(t)) return Array.from(out);
  if(syn[t]) syn[t].forEach(x=>out.add(x));
  out.add(t.replace(/[-\/_]/g,' '));
  out.add(t.replace(/[-\/_]/g,''));
  return Array.from(out).filter(Boolean);
}

function buildIndexEntry(p){
  const nameN = normalize(p.name);
  const artN  = normalize(p.art);
  const hay   = nameN + ' ' + artN;
  const words = new Set(tokenize(hay));
  return Object.assign({}, p, {_nameN:nameN,_artN:artN,_hay:hay,_words:words});
}

function scoreStrict(entry, qGroups){
  let ok = true, score = 0;
  for(const group of qGroups){
    let hit=false, local=0;
    for(const v of group){
      if(entry._hay.includes(v)){
        hit=true;
        local = Math.max(local,(entry._words.has(v)?3:1) + (entry._nameN.startsWith(v)?2:0) + (entry._artN.includes(v)?2:0) + (/^\d/.test(v)?2:0));
      }
    }
    if(!hit){ ok=false; break; }
    score += local;
  }
  return ok ? score + qGroups.length : -1;
}

function scoreAny(entry, qGroups){
  let score = 0, hits=0;
  for(const group of qGroups){
    let local=0, hit=false;
    for(const v of group){
      if(entry._hay.includes(v)){
        hit=true;
        local = Math.max(local,(entry._words.has(v)?3:1) + (entry._nameN.startsWith(v)?2:0) + (entry._artN.includes(v)?2:0));
      }
    }
    if(hit){ hits++; score += local; }
  }
  return hits>0 ? score + hits : -1;
}

function highlight(text, qGroups){
  let out = text;
  for(const group of qGroups){
    const best = group.slice().sort((a,b)=>b.length-a.length)[0];
    if(!best) continue;
    const re = new RegExp(best.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'gi');
    out = out.replace(re, m=>`<mark>${m}</mark>`);
  }
  return out;
}

function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

let DROPDOWN; let DBIDX = [];
async function initDB(){ const db = await loadDB(); DBIDX = db.map(buildIndexEntry); }

const doSearch = debounce(async function(){
  const qraw = document.getElementById('q').value;
  DROPDOWN = DROPDOWN || document.getElementById('dropdown');
  if(!qraw.trim()){ DROPDOWN.classList.add('hidden'); DROPDOWN.innerHTML=''; return; }

  if(!DBIDX.length) await initDB();
  if(!DBIDX.length){ DROPDOWN.innerHTML = '<div class="item"><div class="meta"><div class="title">–ë–∞–∑–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</div><div class="sku">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ data/products.json</div></div></div>'; DROPDOWN.classList.remove('hidden'); return; }

  const qTokens = tokenize(qraw);
  const qGroups = qTokens.map(expandToken);

  let scored = [];
  if(qGroups.length === 1){
    for(const e of DBIDX){ const s = scoreAny(e, qGroups); if(s>=0) scored.push([s,e]); }
  } else {
    for(const e of DBIDX){ const s = scoreStrict(e, qGroups); if(s>=0) scored.push([s,e]); }
    if(scored.length < 10){
      scored = [];
      for(const e of DBIDX){ const s = scoreAny(e, qGroups); if(s>=0) scored.push([s,e]); }
    }
  }

  scored.sort((a,b)=>b[0]-a[0]);
  const top = scored.slice(0, 150).map(x=>x[1]);
  renderDropdown(top, qGroups);
}, 120);

function search(){ doSearch(); }

function renderDropdown(items, qGroups){
  const el = DROPDOWN;
  if(!items.length){
    el.innerHTML = `<div class="item"><div class="meta"><div class="title">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div><div class="sku">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ: ¬´—Ç—Ä—É–±–∞ pex 16¬ª, ¬´—Ç—Ä—É–±–∞ –ø–µ—Ä—Ç 20¬ª, ¬´–º/–ø 16¬ª</div></div></div>`;
    el.classList.remove('hidden'); return;
  }
  el.innerHTML = items.map(p=>`
    <div class="item">
      <img class="thumb" src="${imgOrPlaceholder(p.img)}" onerror="this.src='assets/ph.png'"/>
      <div class="meta">
        <div class="title">${highlight(escapeHtml(p.name), qGroups)}</div>
        <div class="sku">(–∞—Ä—Ç. ${highlight(escapeHtml(p.art), qGroups)}) ${p.price? ' ¬∑ '+String(p.price): ''}</div>
      </div>
      <div class="actions">
        <button class="btn" onclick='addToCart(${JSON.stringify({art:""+p.art,name:""+p.name,img:p.img,price:p.price}).replace(/"/g,'&quot;')});event.stopPropagation()'>–î–æ–±–∞–≤–∏—Ç—å</button>
        ${p.imgLarge ? `<a class="btn" href="${p.imgLarge}" target="_blank" title="–§–æ—Ç–æ –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ">üîç</a>` : ''}
      </div>
    </div>
  `).join('');
  el.classList.remove('hidden');
}

function openCart(){ window.open('cart.html','_blank'); }

document.addEventListener('DOMContentLoaded', () => {
  const priceInput = document.getElementById('pricecsv'); if(priceInput){ priceInput.addEventListener('change', async (e)=>{ const f = e.target.files[0]; if(!f) return; const text = await f.text(); localStorage.setItem('price_map_csv', text); DB = []; DBIDX = []; toast('–¶–µ–Ω—ã/–æ—Å—Ç–∞—Ç–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã ‚úî'); search(); }); }
  const imgInput = document.getElementById('csv'); if(imgInput){ imgInput.addEventListener('change', async (e)=>{ const f = e.target.files[0]; if(!f) return; const text = await f.text(); localStorage.setItem('images_map_csv', text); DB = []; DBIDX = []; toast('–§–æ—Ç–æ-–∫–∞—Ä—Ç–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ ‚úî'); search(); }); }
  updateBadge();
});

</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function(){ navigator.serviceWorker.register('sw.js').catch(function(){}); });
}
</script>
</body>
</html>
