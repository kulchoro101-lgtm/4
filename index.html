<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞ ‚Äî Teplostil</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="assets/icon.png">
<style>*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#ffffff;color:#0f172a}
.header{position:fixed;top:0;left:0;right:0;height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:#ffffff;border-bottom:1px solid #e5e7eb;z-index:20}
.brand{font-weight:700;letter-spacing:.3px;color:#0f172a}
.cart{position:relative;cursor:pointer}
.cart .badge{position:absolute;top:-6px;right:-8px;background:#2563eb;color:#fff;border-radius:12px;padding:2px 6px;font-size:12px;min-width:20px;text-align:center}
.container{max-width:900px;margin:120px auto 64px;padding:0 16px}
.search-wrap{display:flex;align-items:center;gap:8px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:999px;padding:8px 16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.search-wrap input{flex:1;background:transparent;border:0;outline:0;color:#0f172a;font-size:20px;padding:8px}
.search-results{position:relative;margin-top:14px}
.dropdown{position:absolute;left:0;right:0;background:#ffffff;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;max-height:480px;overflow-y:auto;box-shadow:0 8px 24px rgba(15,23,42,.08)}
.item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid #f1f5f9}
.item:last-child{border-bottom:0}
.thumb{width:48px;height:48px;border-radius:8px;background:#f1f5f9;object-fit:cover;flex:0 0 48px;border:1px solid #e5e7eb}
.meta{display:flex;flex-direction:column;gap:2px;min-width:0}
.title{font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#0f172a}
.sku{font-size:13px;color:#64748b}
.price{font-size:13px;color:#0f172a}
.item .actions{margin-left:auto;display:flex;gap:8px}
.btn{background:#f8fafc;border:1px solid #e5e7eb;color:#0f172a;border-radius:10px;padding:6px 10px;font-size:14px;cursor:pointer}
.btn:hover{background:#eef2f7}
.footer{opacity:.8;font-size:12px;text-align:center;margin-top:32px;color:#475569}
.link{color:#2563eb;text-decoration:none}
.help{margin-top:12px;font-size:13px;color:#475569}
.admin{margin-top:18px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.admin input[type=file]{display:none}
.pill{border:1px dashed #cbd5e1;border-radius:999px;padding:6px 12px;font-size:13px;cursor:pointer;color:#0f172a;background:#ffffff}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#0f172a;color:#fff;border:1px solid #0f172a;padding:10px 14px;border-radius:10px;display:none;z-index:50}
.hidden{display:none}
mark{background:#fde68a}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{border-bottom:1px solid #e5e7eb;padding:8px 6px;text-align:left;font-size:14px}
.sum{display:flex;justify-content:flex-end;gap:24px;margin-top:12px;font-weight:600}</style>
</head>
<body>
<header class="header">
  <div class="brand">Teplostil ¬∑ –ó–∞–∫–∞–∑</div>
  <div class="cart" onclick="openCart()">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="#0f172a"><path d="M7 4h-2l-1 2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.11.89 2 2 2h10v-2h-9.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h5.72c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1h-14.31l-.94-2zm-1 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
    <div id="cart-badge" class="badge">0</div>
  </div>
</header>

<main class="container">
  <div class="search-wrap">
    <input id="q" type="search" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ç—Ä—É–±–∞ –ø–µ—Ä—Ç —ç–≤–æ–Ω 16" autocomplete="off" autofocus/>
  </div>
  <div class="help">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç <b>—Ç–æ–ª—å–∫–æ</b> –ø–æ–∑–∏—Ü–∏–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –≤—Å–µ —Å–ª–æ–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ (–≤ –ª—é–±–æ–º –ø–æ—Ä—è–¥–∫–µ). –°–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ–¥—Å–≤–µ—á–µ–Ω—ã.</div>
  <div class="search-results">
    <div id="dropdown" class="dropdown hidden"></div>
  </div>

  <div class="admin">
    <label for="csv-price" class="pill">üí∞ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ü–µ–Ω—ã/–æ—Å—Ç–∞—Ç–∫–∏ (–ê—Ä—Ç–∏–∫—É–ª;–¶–µ–Ω–∞;–û—Å—Ç–∞—Ç–æ–∫)</label>
    <input id="csv-price" type="file" accept=".csv" />
    <label for="csv-img" class="pill">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å CSV —Å —Ñ–æ—Ç–æ (–ê—Ä—Ç–∏–∫—É–ª;image_small;image_large)</label>
    <input id="csv-img" type="file" accept=".csv" />
    <a class="pill link" href="cart.html" target="_blank">üß∫ –û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É</a>
  </div>

  <div class="footer">–†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω ¬∑ –î–∞–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã –∏ —Ü–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ</div>
</main>

<div id="toast" class="toast"></div>

<script>const DB_URL = 'data/products.json';
let DB = [];
const CART_KEY = 'cart_v2';
const placeholder = 'assets/ph.png';

function toast(msg){
  const t=document.getElementById('toast');
  if(!t) return;
  t.textContent=msg; t.style.display='block';
  setTimeout(()=>t.style.display='none',1800);
}

function loadCart(){
  try{ return JSON.parse(localStorage.getItem(CART_KEY)||'[]'); }
  catch(_){ return []; }
}
function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); updateBadge(); }

function updateBadge(){
  const c = loadCart();
  const cnt = c.reduce((s,i)=>s+(i.qty||0),0);
  const el = document.getElementById('cart-badge');
  if(el) el.textContent = String(cnt);
}

function addToCart(item){
  const c = loadCart();
  const idx = c.findIndex(x=>x.art===item.art);
  if(idx>=0) c[idx].qty += 1;
  else c.push({art:item.art, name:item.name, img:item.img||'', price:item.price||0, qty:1});
  saveCart(c); toast('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É');
}

function removeFromCart(art){ saveCart(loadCart().filter(x=>x.art!==art)); }

function setQty(art, qty){
  qty = Math.max(0, parseInt(qty||0,10));
  const c = loadCart();
  for(const it of c){ if(it.art===art) it.qty = qty; }
  saveCart(c.filter(x=>x.qty>0));
}

function money(n){
  const v = Number(n||0);
  if(!isFinite(v)) return '';
  return v.toLocaleString('ru-RU');
}

function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(Boolean);
  if(!lines.length) return [];
  const headers = lines[0].split(';').map(h=>h.trim());
  return lines.slice(1).map(line=>{
    const cols = line.split(';');
    const obj = {};
    headers.forEach((h,i)=>obj[h]= (cols[i]||'').trim());
    return obj;
  });
}

function applyPriceMap(DB){
  const csv = localStorage.getItem('price_map_csv');
  if(!csv) return;
  const rows = parseCSV(csv);
  const map = new Map();
  rows.forEach(r=> map.set((r['–ê—Ä—Ç–∏–∫—É–ª']||'').trim(), r));
  DB.forEach(it=>{
    const r = map.get(it.art);
    if(r){
      const p = Number((r['–¶–µ–Ω–∞']||'').replace(/\s+/g,''));
      const st= Number((r['–û—Å—Ç–∞—Ç–æ–∫']||'').replace(/\s+/g,''));
      if(!Number.isNaN(p)) it.price = p;
      if(!Number.isNaN(st)) it.stock = st;
    }
  });
}

function applyImageMap(DB){
  const csv = localStorage.getItem('images_map_csv');
  if(!csv) return;
  const rows = parseCSV(csv);
  const map = new Map();
  rows.forEach(r=> map.set((r['–ê—Ä—Ç–∏–∫—É–ª']||'').trim(), r));
  DB.forEach(it=>{
    const r = map.get(it.art);
    if(r){
      if(r['image_small']) it.img = r['image_small'];
      if(r['image_large']) it.imgLarge = r['image_large'];
    }
  });
}

async function loadDB(){
  if(DB.length) return DB;
  const res = await fetch(DB_URL, {cache:'no-store'});
  const arr = await res.json();
  DB = arr.map(p=>({
    art: String(p['–ê—Ä—Ç–∏–∫—É–ª']||'').trim(),
    name: String(p['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ']||'').trim(),
    img: (p['image_small']||p['image_large']||'').trim(),
    imgLarge: (p['image_large']||p['image_small']||'').trim(),
    price: Number(p['–¶–µ–Ω–∞']||0)||0,
    stock: Number(p['–û—Å—Ç–∞—Ç–æ–∫']||0)||0,
  }));
  applyImageMap(DB);
  applyPriceMap(DB);
  return DB;
}

function imgOrPlaceholder(url){ return (url && url.length>3) ? url : 'assets/ph.png'; }
function norm(s){
  return String(s||'')
    .toLowerCase()
    .replace(/—ë/g,'–µ')
    .replace(/[.,/\\()_\-+"]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}
function tokenize(q){
  let t = norm(q).split(' ').filter(Boolean);
  return t.map(x=>{
    if(x.startsWith('—ç–≤–æ')) return 'evoh';
    if(x.startsWith('–ø–µ—Ä—Ç')) return 'pert';
    if(x==='–ø–µ–∫—Å' || x==='pex') return 'pex';
    return x;
  });
}
function containsAllTokens(hay, tokens){
  for(const t of tokens){ if(!hay.includes(t)) return false; }
  return true;
}
function highlight(text, tokens){
  let s = text;
  for(const t of tokens){
    if(!t) continue;
    try{
      const re = new RegExp('('+t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi');
      s = s.replace(re,'<mark>$1</mark>');
    }catch(_){}
  }
  return s;
}
async function searchStrict(){
  const q = document.getElementById('q').value;
  const tokens = tokenize(q);
  const box = document.getElementById('dropdown');
  if(!tokens.length){ box.classList.add('hidden'); box.innerHTML=''; return; }
  const db = await loadDB();
  const results = [];
  for(const p of db){
    const hay = norm(p.name) + ' ' + norm(p.art);
    if(containsAllTokens(hay, tokens)){
      const pos = tokens.reduce((s,t)=> s + Math.max(0, hay.indexOf(t)), 0);
      results.push({p, pos});
    }
  }
  results.sort((a,b)=> a.pos - b.pos);
  renderDropdown(results.slice(0,50).map(r=>r.p), tokens);
}
function renderDropdown(items, tokens){
  const el = document.getElementById('dropdown');
  el.innerHTML = items.map(p=>`
    <div class="item">
      <img class="thumb" src="${imgOrPlaceholder(p.img)}" onerror="this.src='assets/ph.png'"/>
      <div class="meta">
        <div class="title">${highlight(escapeHtml(p.name), tokens)}</div>
        <div class="sku">(–∞—Ä—Ç. ${escapeHtml(p.art)})</div>
        ${p.price? `<div class="price">${money(p.price)} —Å</div>`:''}
      </div>
      <div class="actions">
        <button class="btn add-btn" data-art="${p.art}">–î–æ–±–∞–≤–∏—Ç—å</button>
        ${p.imgLarge ? `<a class="btn" href="${p.imgLarge}" target="_blank" title="–§–æ—Ç–æ –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ">üîç</a>` : ''}
      </div>
    </div>
  `).join('');
  el.querySelectorAll('button.add-btn').forEach(btn=>{
    const art = btn.getAttribute('data-art');
    btn.onclick = (ev)=>{
      ev.stopPropagation();
      const item = items.find(x=>x.art===art);
      if(item) addToCart(item);
    };
  });
  el.classList.remove('hidden');
}
function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))}
function openCart(){ window.open('cart.html','_blank'); }
document.addEventListener('DOMContentLoaded', () => {
  const q = document.getElementById('q');
  if(q){ q.addEventListener('input', searchStrict); }
  const csvPrice = document.getElementById('csv-price');
  if(csvPrice){
    csvPrice.addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text();
      localStorage.setItem('price_map_csv', text);
      DB = []; toast('–¶–µ–Ω—ã/–æ—Å—Ç–∞—Ç–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã ‚úî'); searchStrict();
    });
  }
  const csvImg = document.getElementById('csv-img');
  if(csvImg){
    csvImg.addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text();
      localStorage.setItem('images_map_csv', text);
      DB = []; toast('–§–æ—Ç–æ-–∫–∞—Ä—Ç–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ ‚úî'); searchStrict();
    });
  }
  updateBadge();
});</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function(){ navigator.serviceWorker.register('sw.js').catch(function(){}); });
}
</script>
</body>
</html>