<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ö–æ—Ä–∑–∏–Ω–∞ ‚Äî Teplostil</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="assets/icon.png">
<style>*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#ffffff;color:#0f172a}
.header{position:fixed;top:0;left:0;right:0;height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:#ffffff;border-bottom:1px solid #e5e7eb;z-index:20}
.brand{font-weight:700;letter-spacing:.3px;color:#0f172a}
.cart{position:relative;cursor:pointer}
.cart .badge{position:absolute;top:-6px;right:-8px;background:#2563eb;color:#fff;border-radius:12px;padding:2px 6px;font-size:12px;min-width:20px;text-align:center}
.container{max-width:900px;margin:120px auto 64px;padding:0 16px}
.search-wrap{display:flex;align-items:center;gap:8px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:999px;padding:8px 16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.search-wrap input{flex:1;background:transparent;border:0;outline:0;color:#0f172a;font-size:20px;padding:8px}
.search-results{position:relative;margin-top:14px}
.dropdown{position:absolute;left:0;right:0;background:#ffffff;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;max-height:480px;overflow-y:auto;box-shadow:0 8px 24px rgba(15,23,42,.08)}
.item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid #f1f5f9}
.item:last-child{border-bottom:0}
.thumb{width:48px;height:48px;border-radius:8px;background:#f1f5f9;object-fit:cover;flex:0 0 48px;border:1px solid #e5e7eb}
.meta{display:flex;flex-direction:column;gap:2px;min-width:0}
.title{font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#0f172a}
.sku{font-size:13px;color:#64748b}
.price{font-size:13px;color:#0f172a}
.item .actions{margin-left:auto;display:flex;gap:8px}
.btn{background:#f8fafc;border:1px solid #e5e7eb;color:#0f172a;border-radius:10px;padding:6px 10px;font-size:14px;cursor:pointer}
.btn:hover{background:#eef2f7}
.footer{opacity:.8;font-size:12px;text-align:center;margin-top:32px;color:#475569}
.link{color:#2563eb;text-decoration:none}
.help{margin-top:12px;font-size:13px;color:#475569}
.admin{margin-top:18px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.admin input[type=file]{display:none}
.pill{border:1px dashed #cbd5e1;border-radius:999px;padding:6px 12px;font-size:13px;cursor:pointer;color:#0f172a;background:#ffffff}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#0f172a;color:#fff;border:1px solid #0f172a;padding:10px 14px;border-radius:10px;display:none;z-index:50}
.hidden{display:none}
mark{background:#fde68a}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{border-bottom:1px solid #e5e7eb;padding:8px 6px;text-align:left;font-size:14px}
.sum{display:flex;justify-content:flex-end;gap:24px;margin-top:12px;font-weight:600}</style>
</head>
<body>
<header class="header">
  <div class="brand">–ö–æ—Ä–∑–∏–Ω–∞</div>
  <a class="pill link" href="index.html">‚Üê –ö –ø–æ–∏—Å–∫—É</a>
</header>
<main class="container">
  <div id="cart-list"></div>
  <div class="sum">–ò—Ç–æ–≥–æ: <span id="total">0</span> —Å</div>
  <div class="admin" style="margin-top:24px">
    <button class="pill" onclick="exportCartCSV()">üì• Excel (CSV)</button>
    <button class="pill" onclick="exportCartMXL()">üì• MXL</button>
    <button class="pill" onclick="clearCart()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
  </div>
</main>
<div id="toast" class="toast"></div>
<script>const DB_URL = 'data/products.json';
let DB = [];
const CART_KEY = 'cart_v2';
const placeholder = 'assets/ph.png';

function toast(msg){
  const t=document.getElementById('toast');
  if(!t) return;
  t.textContent=msg; t.style.display='block';
  setTimeout(()=>t.style.display='none',1800);
}

function loadCart(){
  try{ return JSON.parse(localStorage.getItem(CART_KEY)||'[]'); }
  catch(_){ return []; }
}
function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); updateBadge(); }

function updateBadge(){
  const c = loadCart();
  const cnt = c.reduce((s,i)=>s+(i.qty||0),0);
  const el = document.getElementById('cart-badge');
  if(el) el.textContent = String(cnt);
}

function addToCart(item){
  const c = loadCart();
  const idx = c.findIndex(x=>x.art===item.art);
  if(idx>=0) c[idx].qty += 1;
  else c.push({art:item.art, name:item.name, img:item.img||'', price:item.price||0, qty:1});
  saveCart(c); toast('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É');
}

function removeFromCart(art){ saveCart(loadCart().filter(x=>x.art!==art)); }

function setQty(art, qty){
  qty = Math.max(0, parseInt(qty||0,10));
  const c = loadCart();
  for(const it of c){ if(it.art===art) it.qty = qty; }
  saveCart(c.filter(x=>x.qty>0));
}

function money(n){
  const v = Number(n||0);
  if(!isFinite(v)) return '';
  return v.toLocaleString('ru-RU');
}

function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(Boolean);
  if(!lines.length) return [];
  const headers = lines[0].split(';').map(h=>h.trim());
  return lines.slice(1).map(line=>{
    const cols = line.split(';');
    const obj = {};
    headers.forEach((h,i)=>obj[h]= (cols[i]||'').trim());
    return obj;
  });
}

function applyPriceMap(DB){
  const csv = localStorage.getItem('price_map_csv');
  if(!csv) return;
  const rows = parseCSV(csv);
  const map = new Map();
  rows.forEach(r=> map.set((r['–ê—Ä—Ç–∏–∫—É–ª']||'').trim(), r));
  DB.forEach(it=>{
    const r = map.get(it.art);
    if(r){
      const p = Number((r['–¶–µ–Ω–∞']||'').replace(/\s+/g,''));
      const st= Number((r['–û—Å—Ç–∞—Ç–æ–∫']||'').replace(/\s+/g,''));
      if(!Number.isNaN(p)) it.price = p;
      if(!Number.isNaN(st)) it.stock = st;
    }
  });
}

function applyImageMap(DB){
  const csv = localStorage.getItem('images_map_csv');
  if(!csv) return;
  const rows = parseCSV(csv);
  const map = new Map();
  rows.forEach(r=> map.set((r['–ê—Ä—Ç–∏–∫—É–ª']||'').trim(), r));
  DB.forEach(it=>{
    const r = map.get(it.art);
    if(r){
      if(r['image_small']) it.img = r['image_small'];
      if(r['image_large']) it.imgLarge = r['image_large'];
    }
  });
}

async function loadDB(){
  if(DB.length) return DB;
  const res = await fetch(DB_URL, {cache:'no-store'});
  const arr = await res.json();
  DB = arr.map(p=>({
    art: String(p['–ê—Ä—Ç–∏–∫—É–ª']||'').trim(),
    name: String(p['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ']||'').trim(),
    img: (p['image_small']||p['image_large']||'').trim(),
    imgLarge: (p['image_large']||p['image_small']||'').trim(),
    price: Number(p['–¶–µ–Ω–∞']||0)||0,
    stock: Number(p['–û—Å—Ç–∞—Ç–æ–∫']||0)||0,
  }));
  applyImageMap(DB);
  applyPriceMap(DB);
  return DB;
}

function imgOrPlaceholder(url){ return (url && url.length>3) ? url : 'assets/ph.png'; }
function renderCart(){
  const c = loadCart();
  const root = document.getElementById('cart-list');
  if(!c.length){ 
    root.innerHTML = '<div class="help">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>'; 
    updateBadge(); 
    document.getElementById('total').textContent = '0';
    return; 
  }
  const rows = c.map(i=>`
    <tr>
      <td>${escapeHtml(i.name)}<div class="sku">(–∞—Ä—Ç. ${escapeHtml(i.art)})</div></td>
      <td>${i.price? money(i.price): ''}</td>
      <td>
        <button class="btn" onclick="chg('${i.art}',-1)">‚Äì</button>
        <span class="btn">${i.qty}</span>
        <button class="btn" onclick="chg('${i.art}',+1)">+</button>
      </td>
      <td><button class="btn" onclick="delItem('${i.art}')">üóë</button></td>
    </tr>
  `).join('');
  root.innerHTML = `
    <table class="table">
      <thead><tr><th>–¢–æ–≤–∞—Ä</th><th>–¶–µ–Ω–∞</th><th>–ö–æ–ª-–≤–æ</th><th></th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
  const total = c.reduce((s,i)=> s + (i.qty||0) * (Number(i.price)||0), 0);
  document.getElementById('total').textContent = money(total);
  updateBadge();
}
function chg(art, d){
  const c = loadCart();
  for(const it of c){ if(it.art===art){ it.qty = Math.max(0,(it.qty||0)+d); } }
  saveCart(c.filter(x=>x.qty>0)); renderCart();
}
function delItem(art){ removeFromCart(art); renderCart(); }
function clearCart(){ saveCart([]); renderCart(); toast('–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞'); }
function exportCartCSV(){
  const c = loadCart();
  const rows = [['–ê—Ä—Ç–∏–∫—É–ª','–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ','–¶–µ–Ω–∞','–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ','–°—É–º–º–∞']]
    .concat(c.map(i=>[i.art, i.name, i.price||'', i.qty||0, (i.qty||0)*(i.price||0)]));
  const csv = rows.map(r=>r.join(';')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'order.csv'; a.click();
}
function exportCartMXL(){
  const c = loadCart();
  const esc = s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const xml = ['<?xml version="1.0" encoding="UTF-8"?>','<order>']
    .concat(c.map(i=>`<item><art>${esc(i.art)}</art><name>${esc(i.name)}</name><price>${i.price||0}</price><qty>${i.qty||0}</qty></item>`))
    .concat(['</order>']).join('\n');
  const blob = new Blob([xml], {type:'application/xml;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'order.mxl'; a.click();
}
function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))}
document.addEventListener('DOMContentLoaded', () => { updateBadge(); renderCart(); });</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function(){ navigator.serviceWorker.register('sw.js').catch(function(){}); });
}
</script>
</body>
</html>