<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ö–æ—Ä–∑–∏–Ω–∞ ‚Äî Teplostil</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="assets/icon.png">
<style>*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#ffffff;color:#0f172a}
.header{position:fixed;top:0;left:0;right:0;height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:#ffffff;border-bottom:1px solid #e5e7eb;z-index:20}
.brand{font-weight:700;letter-spacing:.3px;color:#0f172a}
.cart{position:relative;cursor:pointer}
.cart .badge{position:absolute;top:-6px;right:-8px;background:#2563eb;color:#fff;border-radius:12px;padding:2px 6px;font-size:12px;min-width:20px;text-align:center}
.container{max-width:900px;margin:120px auto 64px;padding:0 16px}
.search-wrap{display:flex;align-items:center;gap:8px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:999px;padding:8px 16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.search-wrap input{flex:1;background:transparent;border:0;outline:0;color:#0f172a;font-size:20px;padding:8px}
.search-results{position:relative;margin-top:14px}
.dropdown{position:absolute;left:0;right:0;background:#ffffff;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;max-height:520px;overflow-y:auto;box-shadow:0 8px 24px rgba(15,23,42,.08)}
.item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid #f1f5f9}
.item:last-child{border-bottom:0}
.thumb{width:48px;height:48px;border-radius:8px;background:#f1f5f9;object-fit:cover;flex:0 0 48px;border:1px solid #e5e7eb}
.meta{display:flex;flex-direction:column;gap:2px;min-width:0}
.title{font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#0f172a}
.sku{font-size:13px;color:#64748b}
.item .actions{margin-left:auto;display:flex;gap:8px}
.btn{background:#f8fafc;border:1px solid #e5e7eb;color:#0f172a;border-radius:10px;padding:6px 10px;font-size:14px;cursor:pointer}
.btn:hover{background:#eef2f7}
.footer{opacity:.8;font-size:12px;text-align:center;margin-top:32px;color:#475569}
.link{color:#2563eb;text-decoration:none}
.help{margin-top:12px;font-size:13px;color:#475569}
.admin{margin-top:18px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.admin input[type=file]{display:none}
.pill{border:1px dashed #cbd5e1;border-radius:999px;padding:6px 12px;font-size:13px;cursor:pointer;color:#0f172a;background:#ffffff}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#0f172a;color:#fff;border:1px solid #0f172a;padding:10px 14px;border-radius:10px;display:none;z-index:50}
.hidden{display:none}
mark{background:#fff3bf;padding:0 .1em;border-radius:.2em}
</style>
</head>
<body>
<header class="header">
  <div class="brand">–ö–æ—Ä–∑–∏–Ω–∞</div>
  <a class="pill link" href="index.html">‚Üê –ö –ø–æ–∏—Å–∫—É</a>
</header>
<main class="container">
  <div id="cart-list"></div>
  <div class="admin" style="margin-top:24px">
    <button class="pill" onclick="exportCartXLSX()">üì• Excel</button>
    <button class="pill" onclick="exportCartMXL()">üì• MXL</button>
    <button class="pill" onclick="clearCart()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
  </div>
</main>
<div id="toast" class="toast"></div>
<script>const DB_URL = 'data/products.json'; let DB = []; const CART_KEY = 'cart_v1';
function toast(msg){const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1800);}
function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY)||'[]'); } catch(_){ return []; } }
function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); updateBadge(); }
function updateBadge(){ const c = loadCart(); const cnt = c.reduce((s,i)=>s+(i.qty||0),0); const el = document.getElementById('cart-badge'); if(el) el.textContent = String(cnt); }
function addToCart(item){ const c = loadCart(); const idx = c.findIndex(x=>x.art===item.art); if(idx>=0) c[idx].qty += 1; else c.push({art:item.art, name:item.name, img:item.img||'', qty:1, price:item.price||0}); saveCart(c); toast('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É'); }
function removeFromCart(art){ const c = loadCart().filter(x=>x.art!==art); saveCart(c); }
function setQty(art, qty){ qty = Math.max(0, parseInt(qty||0,10)); const c = loadCart(); for(const it of c){ if(it.art===art) it.qty = qty; } saveCart(c.filter(x=>x.qty>0)); }
function imgOrPlaceholder(url){ return (url && url.length>3) ? url : 'assets/ph.png'; }
function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]) )}
// CSV with BOM (Excel-friendly) + semicolon delimiter
function exportCartXLSX(){
  const c = loadCart();
  const rows = [['–ê—Ä—Ç–∏–∫—É–ª','–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ','–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ','–¶–µ–Ω–∞','–°—É–º–º–∞']].concat(
    c.map(i=>[i.art, i.name, i.qty, i.price||'', (i.qty||0)*(i.price||0)])
  );
  const bom = '\ufeff'; // UTF-8 BOM for Excel
  const csv = rows.map(r=>r.map(v=>String(v).replace(/"/g,'""')).join(';')).join('\n');
  const blob = new Blob([bom + csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'order.csv'; a.click();
}
function exportCartMXL(){
  const c = loadCart(); const esc = s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const xml = ['<?xml version="1.0" encoding="UTF-8"?>','<order>']
    .concat(c.map(i=>`<item><art>${esc(i.art)}</art><name>${esc(i.name)}</name><qty>${i.qty}</qty><price>${i.price||''}</price></item>`))
    .concat(['</order>']).join('\n');
  const blob = new Blob([xml], {type:'application/xml;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'order.mxl'; a.click();
}
// Data loading + local enrich
function parseCSV(text){ const lines = text.split(/\r?\n/).filter(Boolean); if(!lines.length) return []; const headers = lines[0].split(';').map(h=>h.trim()); return lines.slice(1).map(line=>{ const cols = line.split(';'); const obj = {}; headers.forEach((h,i)=>obj[h]=(cols[i]||'').trim()); return obj; }); }
async function loadDB(){
  if(DB.length) return DB;
  try{
    const res = await fetch(DB_URL, {cache:'no-store'});
    const arr = await res.json();
    DB = arr.map(p=>({
      art: String(p['–ê—Ä—Ç–∏–∫—É–ª']||'').trim(),
      name: String(p['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ']||'').trim(),
      img: (p['image_small']||p['image_large']||'').trim(),
      imgLarge: (p['image_large']||p['image_small']||'').trim(),
      price: Number(p['–¶–µ–Ω–∞']||0)||0,
      stock: Number(p['–û—Å—Ç–∞—Ç–æ–∫']||p['–ó–∞–ø–∞—Å']||0)||0,
    }));
  }catch(e){
    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å data/products.json', e);
    DB = [];
  }
  // images enrich
  const imagesCSV = localStorage.getItem('images_map_csv');
  if(imagesCSV){ const map = parseCSV(imagesCSV); for(const row of map){ const art = (row['–ê—Ä—Ç–∏–∫—É–ª']||'').trim(); const it = DB.find(x=>x.art===art); if(it){ if(row['image_small']) it.img = row['image_small']; if(row['image_large']) it.imgLarge = row['image_large']; } } }
  // price enrich
  const priceCSV = localStorage.getItem('price_map_csv');
  if(priceCSV){ const map = parseCSV(priceCSV); for(const row of map){ const art = (row['–ê—Ä—Ç–∏–∫—É–ª']||'').trim(); const it = DB.find(x=>x.art===art); if(it){ if(row['–¶–µ–Ω–∞']) it.price = Number(row['–¶–µ–Ω–∞'])||it.price; if(row['–û—Å—Ç–∞—Ç–æ–∫']) it.stock = Number(row['–û—Å—Ç–∞—Ç–æ–∫'])||it.stock; } } }
  return DB;
}
// Search helpers
const syn = {
  "—Ç—Ä—É–±–∞":["—Ç—Ä—É–±","—Ç—Ä—É–±–æ–ø—Ä–æ–≤–æ–¥","pipe"],
  "–ø–µ—Ä—Ç":["pert","pe-rt","pe rt","pe_rt","pe‚Ä¢rt","pe rt"],
  "—ç–≤–æ":["evoh","evo","–µ–≤–æ—Ö","—ç–≤–æx","—ç–≤–∞—Ö"],
  "—ç–≤–æ–Ω":["evoh","evo"],
  "–µ–≤–æ—Ö":["evoh"],
  "–ø–µ–∫—Å":["pex","p-ex","p ex","p_ex"],
  "–Ω–µ—Ä–∂":["–Ω–µ—Ä–∂–∞–≤","–Ω–µ—Ä–∂–∞–≤–µ–π–∫–∞","stainless","inox"],
  "–º–ø":["–º–µ—Ç–∞–ª–ª–æ–ø–ª–∞—Å—Ç","–º–µ—Ç–∞–ª–ª–æ–ø–ª–∞—Å—Ç–∏–∫","–º/–ø","mp","metal-plast"],
  "–≤–Ω–≤–Ω":["–≤–Ω-–≤–Ω","–≤–Ω—É—Ç—Ä-–≤–Ω—É—Ç—Ä","–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è"],
  "–Ω–∞—Ä–≤–Ω":["–Ω–∞—Ä-–≤–Ω","–Ω–∞—Ä—É–∂-–≤–Ω—É—Ç—Ä","–Ω–∞—Ä—É–∂–Ω–∞—è-–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è"],
  "–≤–Ω–Ω–∞—Ä":["–≤–Ω-–Ω–∞—Ä","–≤–Ω—É—Ç—Ä-–Ω–∞—Ä—É–∂","–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è-–Ω–∞—Ä—É–∂–Ω–∞—è"],
  "–º–º":["mm","–º–∏–ª–ª–∏–º–µ—Ç—Ä","–º–∏–ª–ª–∏–º–µ—Ç—Ä–∞","–º–∏–ª–ª–∏–º–µ—Ç—Ä–æ–≤"],
  "dn":["–¥—É","–¥–∏–∞–º–µ—Ç—Ä"],
  "–æ—Ü":["–æ—Ü–∏–Ω–∫","–æ—Ü–∏–Ω–∫–æ–≤–∞–Ω–Ω—ã–π","galvanized"]
};
function normalize(s){ return String(s||'').toLowerCase().replace(/—ë/g,'–µ').replace(/[^a-z0-9–∞-—è\-\/\.\s]/g,' ').replace(/\s+/g,' ').trim(); }
function tokenize(s){ return normalize(s).split(' ').filter(Boolean); }
function expandToken(t){
  const out = new Set([t]);
  if(/^\d+([.,]\d+)?$/.test(t)) return Array.from(out);
  if(syn[t]) syn[t].forEach(x=>out.add(x));
  if(t.endsWith('—ã')||t.endsWith('–∏')) out.add(t.slice(0,-1));
  if(t.endsWith('–∞—è')||t.endsWith('–∏–π')||t.endsWith('—ã–π')) out.add(t.slice(0,-2));
  out.add(t.replace(/[-\/_]/g,' '));
  out.add(t.replace(/[-\/_]/g,''));
  return Array.from(out).filter(Boolean);
}
function buildIndexEntry(p){
  const nameN = normalize(p.name); const artN = normalize(p.art); const hay = nameN + ' ' + artN;
  const words = new Set(tokenize(hay));
  return Object.assign({}, p, {_nameN:nameN,_artN:artN,_hay:hay,_words:words});
}
function scoreStrict(entry, qGroups){
  let ok = true, score = 0;
  for(const group of qGroups){
    let hit=false, local=0;
    for(const v of group){
      if(entry._hay.includes(v)){
        hit = true;
        const word = entry._words.has(v) ? 3 : 1;
        const starts = entry._nameN.startsWith(v) ? 2 : 0;
        const art = entry._artN.includes(v) ? 2 : 0;
        local = Math.max(local, word+starts+art);
      }
    }
    if(!hit){ ok=false; break; }
    score += local;
  }
  return ok ? score + qGroups.length : -1;
}
function scoreAny(entry, qGroups){
  let score = 0, hits = 0;
  for(const group of qGroups){
    for(const v of group){
      if(entry._hay.includes(v)){ hits++; score += entry._words.has(v)?2:1; break; }
    }
  }
  return hits>0 ? score + hits : -1;
}
function highlight(text, qGroups){
  let out = text;
  for(const group of qGroups){
    const best = group.slice().sort((a,b)=>b.length-a.length)[0];
    if(!best) continue;
    const re = new RegExp(best.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'gi');
    out = out.replace(re, m=>`<mark>${m}</mark>`);
  }
  return out;
}
function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

function render(){
  const c=loadCart(); const root=document.getElementById('cart-list');
  if(!c.length){ root.innerHTML='<div class="help">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>'; updateBadge(); return; }
  const total=c.reduce((s,i)=>s+(i.qty||0)*(i.price||0),0);
  root.innerHTML = c.map(i=>`
    <div class="item">
      <img class="thumb" src="${imgOrPlaceholder(i.img)}" onerror="this.src='assets/ph.png'"/>
      <div class="meta"><div class="title">${escapeHtml(i.name)}</div><div class="sku">(–∞—Ä—Ç. ${escapeHtml(i.art)}) ${i.price? ' ¬∑ '+String(i.price): ''}</div></div>
      <div class="actions"><button class="btn" onclick="chg('${i.art}',-1)">‚Äì</button><span class="btn">${i.qty}</span><button class="btn" onclick="chg('${i.art}',+1)">+</button><button class="btn" onclick="delItem('${i.art}')">üóë</button></div>
    </div>`).join('') + `<div class="item"><div class="meta"><div class="title"><b>–ò—Ç–æ–≥–æ:</b> ${total}</div></div></div>`;
  updateBadge();
}
function chg(art,d){ const c=loadCart(); for(const it of c){ if(it.art===art) it.qty=Math.max(0,(it.qty||0)+d); } saveCart(c.filter(x=>x.qty>0)); render(); }
function delItem(art){ removeFromCart(art); render(); }
function clearCart(){ saveCart([]); render(); toast('–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞'); }
document.addEventListener('DOMContentLoaded', function(){ updateBadge(); render(); });
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function(){ navigator.serviceWorker.register('sw.js').catch(function(){}); });
}
</script>
</body>
</html>
